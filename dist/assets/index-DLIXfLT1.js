var U=Object.defineProperty;var $=(r,t,e)=>t in r?U(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var d=(r,t,e)=>$(r,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();class K{static loadImage(t){return new Promise((e,n)=>{const s=new Image;s.onload=()=>e(s),s.onerror=i=>n(i),s.src=t})}}class J{constructor(){d(this,"down",new Set);d(this,"pressed",new Set);window.addEventListener("keydown",t=>{const e=t.code;(e==="ArrowUp"||e==="ArrowDown"||e==="ArrowLeft"||e==="ArrowRight"||e==="Space")&&t.preventDefault(),this.down.has(e)||this.pressed.add(e),this.down.add(e)}),window.addEventListener("keyup",t=>{this.down.delete(t.code)}),window.addEventListener("blur",()=>{this.down.clear()})}isDown(t){return this.down.has(t)}wasPressed(t){return this.consume(this.pressed,t)}consume(t,e){return t.has(e)?(t.delete(e),!0):!1}updateFrame(){this.pressed.clear()}}class p{constructor(t=0,e=0){this.x=t,this.y=e}clone(){return new p(this.x,this.y)}set(t,e){return this.x=t,this.y=e,this}add(t){return this.x+=t.x,this.y+=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return this.x*=t,this.y*=t,this}dot(t){return this.x*t.x+this.y*t.y}len(){return Math.hypot(this.x,this.y)}normalize(){const t=this.len();return t>1e-8&&(this.x/=t,this.y/=t),this}rotated(t){const e=Math.cos(t),n=Math.sin(t);return new p(this.x*e-this.y*n,this.x*n+this.y*e)}static add(t,e){return new p(t.x+e.x,t.y+e.y)}static sub(t,e){return new p(t.x-e.x,t.y-e.y)}static scale(t,e){return new p(t.x*e,t.y*e)}}class Q{constructor(t,e,n){d(this,"pos");d(this,"vel");d(this,"radius",3);d(this,"life",0);d(this,"maxLife",4);d(this,"damage",12);d(this,"owner");this.pos=t.clone(),this.vel=e.clone(),this.owner=n}update(t){this.pos.add(p.scale(this.vel,t)),this.life+=t}get alive(){return this.life<this.maxLife}draw(t,e,n,s){const i=this.pos.x-e.x+n/2,o=this.pos.y-e.y+s/2;t.save(),t.fillStyle="#1f2937",t.beginPath(),t.arc(i,o,this.radius,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255,255,255,0.5)",t.beginPath(),t.arc(i-this.radius*.3,o-this.radius*.3,this.radius*.4,0,Math.PI*2),t.fill(),t.restore()}}class N{constructor(t={},e){d(this,"pos",new p(0,0));d(this,"vel",new p(0,0));d(this,"angle",-Math.PI/2);d(this,"angVel",0);d(this,"rudder",0);d(this,"maxHealth",100);d(this,"health",100);d(this,"isPlayer",!1);d(this,"isSinking",!1);d(this,"sinkTimer",0);d(this,"sinkDuration",10);d(this,"maxSpeed",180);d(this,"thrust",50);d(this,"reverseThrust",20);d(this,"turnAccel",1);d(this,"rudderRate",1.5);d(this,"linDrag",.4);d(this,"angDrag",2);d(this,"length");d(this,"width");d(this,"cannons",[]);d(this,"sprite");d(this,"portIndices",[]);d(this,"starboardIndices",[]);d(this,"nextPort",0);d(this,"nextStarboard",0);d(this,"fireTimerPort",0);d(this,"fireTimerStarboard",0);d(this,"interShotDelay",.08);this.length=t.length??120,this.width=t.width??44;const n=t.cannonPairs??6;this.sprite=e,this.setupCannons(n)}setupCannons(t){const e=this.length*.18,n=this.length-e*2;for(let s=0;s<t;s++){const i=(s+.5)/t,o=-this.length/2+e+n*i,a=this.width/2,l=2.2+Math.random()*1.4;this.cannons.push({offset:new p(o,+a),side:"starboard",reloadTime:l,cooldown:0}),this.starboardIndices.push(this.cannons.length-1),this.cannons.push({offset:new p(o,-a),side:"port",reloadTime:l*(.9+Math.random()*.2),cooldown:0}),this.portIndices.push(this.cannons.length-1)}}forwardVec(){return new p(Math.cos(this.angle),Math.sin(this.angle))}rightVec(){return new p(Math.cos(this.angle+Math.PI/2),Math.sin(this.angle+Math.PI/2))}update(t,e,n){if(this.isSinking){this.sinkTimer+=t,this.vel.set(0,0),this.angVel=0,this.rudder=0;return}const s=this.forwardVec();e.up&&this.vel.add(p.scale(s,this.thrust*t)),e.down&&this.vel.add(p.scale(s,-this.reverseThrust*t));let i=this.vel.len();i>this.maxSpeed&&this.vel.scale(this.maxSpeed/Math.max(1e-6,i));const o=(e.left?-1:0)+(e.right?1:0),a=Math.max(-1,Math.min(1,o));this.rudder<a?this.rudder=Math.min(a,this.rudder+this.rudderRate*t):this.rudder>a&&(this.rudder=Math.max(a,this.rudder-this.rudderRate*t)),i=this.vel.len();const l=.4+1.2*Math.min(1,i/this.maxSpeed);this.angVel+=this.rudder*this.turnAccel*l*t;const h=1/(1+this.linDrag*t);this.vel.scale(h);const f=1/(1+this.angDrag*t);this.angVel*=f,this.pos.add(p.scale(this.vel,t)),this.angle+=this.angVel*t;for(const u of this.cannons)u.cooldown=Math.max(0,u.cooldown-t);this.fireTimerPort=Math.max(0,this.fireTimerPort-t),this.fireTimerStarboard=Math.max(0,this.fireTimerStarboard-t),e.fire&&(this.tryFireSide("port",n),this.tryFireSide("starboard",n))}localToWorld(t){const e=t.rotated(this.angle);return p.add(this.pos,e)}tryFireSide(t,e){const n=t==="port"?this.portIndices:this.starboardIndices;if(!n.length||(t==="port"?this.fireTimerPort:this.fireTimerStarboard)>0)return;let i=t==="port"?this.nextPort:this.nextStarboard;const o=n.length;for(let a=0;a<o;a++){const l=n[(i+a)%o],h=this.cannons[l];if(h.cooldown<=0){const f=this.rightVec(),u=t==="starboard"?f.clone():f.clone().scale(-1),y=380,w=.04,x=this.localToWorld(h.offset),v=u.rotated((Math.random()-.5)*w),P=p.add(this.vel,p.scale(v,y));e.push(new Q(x,P,this)),h.cooldown=h.reloadTime,i=(i+a+1)%o,t==="port"?(this.nextPort=i,this.fireTimerPort=this.interShotDelay):(this.nextStarboard=i,this.fireTimerStarboard=this.interShotDelay);return}}}draw(t,e,n,s){const i=this.pos.x-e.x+n/2,o=this.pos.y-e.y+s/2;t.save(),t.translate(i,o),t.rotate(this.angle);let a=1;if(this.isSinking&&(a=Math.max(0,1-this.sinkTimer/this.sinkDuration),t.globalAlpha=a),this.sprite){const l=this.length/this.sprite.width,h=this.sprite.width*l,f=this.sprite.height*l;t.drawImage(this.sprite,-h/2,-f/2,h,f)}else{const l=this.isSinking?"#666666":"#5b3b1a",h=this.isSinking?"#333333":"#2c1b0b";t.fillStyle=l,t.strokeStyle=h;const f=this.length,u=this.width;t.beginPath(),t.moveTo(+f/2,0),t.bezierCurveTo(+f/4,+u/2,-f/4,+u/2,-f/2,+u/3),t.lineTo(-f/2,-u/3),t.bezierCurveTo(-f/4,-u/2,+f/4,-u/2,+f/2,0),t.closePath(),t.fill(),t.lineWidth=2,t.stroke()}t.restore(),t.globalAlpha=1,this.isSinking||this.drawHealthBar(t,e,n,s)}drawHealthBar(t,e,n,s){const i=Math.max(0,Math.min(1,this.health/this.maxHealth)),o=this.pos.x-e.x+n/2,a=this.pos.y-e.y+s/2,l=Math.max(30,this.length*.5),h=6,f=a-this.width-18;t.save(),t.fillStyle="rgba(0,0,0,0.45)",t.fillRect(o-l/2,f,l,h),t.fillStyle=i>.5?"#34d399":i>.25?"#f59e0b":"#ef4444",t.fillRect(o-l/2,f,l*i,h),t.strokeStyle="rgba(255,255,255,0.25)",t.lineWidth=1,t.strokeRect(o-l/2,f,l,h),t.restore()}takeDamage(t){this.health=Math.max(0,this.health-t)}startSinking(){this.isSinking||(this.isSinking=!0,this.sinkTimer=0)}isFullySunk(){return this.isSinking&&this.sinkTimer>=this.sinkDuration}hitsCircle(t,e){const n=p.sub(t,this.pos).rotated(-this.angle),s=this.length/2,i=this.width/2,o=Math.max(-s,Math.min(s,n.x)),a=Math.max(-i,Math.min(i,n.y)),l=n.x-o,h=n.y-a;return l*l+h*h<=e*e}}class H extends N{constructor(e,n={}){var s;super(n.ship??{},n.sprite);d(this,"target");d(this,"preferredSide");d(this,"fireRange",520);d(this,"desiredDistance",320);this.target=e,this.preferredSide=((s=n.ai)==null?void 0:s.preferredSide)??(Math.random()<.5?"port":"starboard")}updateAI(e,n,s){const i=p.sub(this.target.pos,this.pos),o=i.len(),a=Math.atan2(i.y,i.x),l=this.angle+Math.PI/2;let h=F(a-l);this.preferredSide==="port"&&(h=F(h+Math.PI));const f=Math.max(160,this.length*1.6),u=new p(0,0);let y=1/0;for(const D of s){if(D===this)continue;const L=p.sub(this.pos,D.pos),R=L.len();if(!(R<=.001)&&(y=Math.min(y,R),R<f)){const W=(f-R)/f;u.add(L.scale(1/R).scale(W*W))}}if(u.len()>.001){const D=Math.cos(l),L=Math.sin(l),R=u.x*D+u.y*L,W=Math.max(-.5,Math.min(.5,R*.8));h=F(h+W)}const w=h>.1,x=h<-.1,v=o<this.desiredDistance*.8?-1:o>this.desiredDistance*1.2?1:0;let P=v>0||this.vel.len()<this.maxSpeed*.35,Y=v<0;y<f*.6&&(P=!1,Y=!0);const V=Math.abs(h)<.2&&o<=this.fireRange;super.update(e,{up:P,down:Y,left:x,right:w,fire:V},n)}}function F(r){for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;return r}const b=document.getElementById("game"),c=b.getContext("2d"),I=window.devicePixelRatio||1;function j(){const r=Math.floor(window.innerWidth),t=Math.floor(window.innerHeight);b.width=Math.floor(r*I),b.height=Math.floor(t*I),b.style.width=r+"px",b.style.height=t+"px",c.setTransform(I,0,0,I,0,0)}window.addEventListener("resize",j);j();const A=new J;let g;const T=[],M=[],k=[],S=new p(0,0),m={minX:-4e3,maxX:4e3,minY:-4e3,maxY:4e3};K.loadImage("/ship.webp").then(r=>O(r)).catch(()=>O());function q(r,t,e){const n=t/I,s=e/I;return{left:r.x-n/2,right:r.x+n/2,top:r.y-s/2,bottom:r.y+s/2}}function Z(r,t){const e=new H(r,{ship:{length:95,width:36,cannonPairs:3},sprite:t});e.maxHealth=60,e.health=e.maxHealth,e.maxSpeed=170,e.thrust=48,e.reverseThrust=18;const n=q(S,b.width,b.height),s=100,i=n.right-n.left-s*2,o=n.bottom-n.top-s*2,a=n.left+s+Math.random()*i,l=n.top+s+Math.random()*o;e.pos.set(a,l);const h=p.sub(r.pos,e.pos);return e.angle=Math.atan2(h.y,h.x)+(Math.random()-.5)*.6,e}function _(r,t){const e=new H(r,{ship:{length:95,width:36,cannonPairs:3},sprite:t});e.maxHealth=60,e.health=e.maxHealth,e.maxSpeed=170,e.thrust=48,e.reverseThrust=18;const n=500,s=0,i=0,o=Math.floor(Math.random()*4);let a,l;switch(o){case 0:a=(Math.random()-.5)*(m.maxX-m.minX)*1.5,l=m.minY-n;break;case 1:a=m.maxX+n,l=(Math.random()-.5)*(m.maxY-m.minY)*1.5;break;case 2:a=(Math.random()-.5)*(m.maxX-m.minX)*1.5,l=m.maxY+n;break;case 3:default:a=m.minX-n,l=(Math.random()-.5)*(m.maxY-m.minY)*1.5;break}e.pos.set(a,l);const h=p.sub(new p(s,i),e.pos);e.angle=Math.atan2(h.y,h.x)+(Math.random()-.5)*.8;const f=50+Math.random()*50,u=h.clone().normalize();return e.vel.set(u.x*f,u.y*f),e}function O(r){g=new N({length:140,width:48,cannonPairs:8},r),g.isPlayer=!0,g.maxHealth=140,g.health=g.maxHealth,M.push(g),et(g);const t=16,e=4;for(let o=0;o<e;o++){const a=Z(g,r);M.push(a),T.push(a)}const n=t-e,s=600,i=2600;for(let o=0;o<n;o++){const a=new H(g,{ship:{length:95,width:36,cannonPairs:3},sprite:r});a.maxHealth=60,a.health=a.maxHealth;const l=Math.random()*Math.PI*2,h=Math.sqrt(Math.random()*(i*i-s*s)+s*s);a.pos.set(g.pos.x+Math.cos(l)*h,g.pos.y+Math.sin(l)*h),a.angle=l+(Math.random()-.5)*.6,a.maxSpeed=170,a.thrust=48,a.reverseThrust=18,M.push(a),T.push(a)}}function tt(r,t,e,n){const s=c.createLinearGradient(0,0,0,t);s.addColorStop(0,"#0b355f"),s.addColorStop(1,"#0a2744"),c.fillStyle=s,c.fillRect(0,0,r,t);const i=80,o=5,a=e.x-r/2,l=e.y-t/2,h=Math.floor(a/i)*i,f=Math.floor(l/i)*i;c.save();for(let u=h,y=0;u<=e.x+r/2;u+=i,y++){const w=u-e.x+r/2,x=y%o===0;c.strokeStyle=x?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.07)",c.lineWidth=x?1.5:1,c.beginPath(),c.moveTo(w,0),c.lineTo(w,t),c.stroke()}for(let u=f,y=0;u<=e.y+t/2;u+=i,y++){const w=u-e.y+t/2,x=y%o===0;c.strokeStyle=x?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.07)",c.lineWidth=x?1.5:1,c.beginPath(),c.moveTo(0,w),c.lineTo(r,w),c.stroke()}c.restore()}let E=performance.now();function G(r){requestAnimationFrame(G);const t=(r-E)/1e3;E=r;const e=Math.min(.033,t);if(!g)return;g.update(e,{up:A.isDown("ArrowUp"),down:A.isDown("ArrowDown"),left:A.isDown("ArrowLeft"),right:A.isDown("ArrowRight"),fire:A.isDown("Space")},k),B(g);for(const o of T)o instanceof H&&o.updateAI(e,k,M),B(o);for(let o=M.length-1;o>=0;o--){const a=M[o];if(a.isFullySunk()){M.splice(o,1);const l=T.indexOf(a);l>=0&&T.splice(l,1)}}for(let o=k.length-1;o>=0;o--){const a=k[o];a.update(e),a.alive||k.splice(o,1)}st(g),ot(M),rt();const n=.25;S.x=g.pos.x+g.vel.x*n,S.y=g.pos.y+g.vel.y*n;for(let o=k.length-1;o>=0;o--){const a=k[o];if(a.pos.x<m.minX||a.pos.x>m.maxX||a.pos.y<m.minY||a.pos.y>m.maxY){k.splice(o,1);continue}for(let l=M.length-1;l>=0;l--){const h=M[l];if(a.owner!==h&&!(h.health<=0||h.isSinking)&&h.hitsCircle(a.pos,a.radius)){h.takeDamage(a.damage),k.splice(o,1),o--,h.health<=0&&!h.isSinking&&h.startSinking();break}}}const s=b.width/I,i=b.height/I;tt(s,i,S),it(s,i);for(const o of k)o.draw(c,S,s,i);for(const o of M)o.draw(c,S,s,i);nt(s,i),A.updateFrame()}requestAnimationFrame(G);let C=[],X=[];function et(r){const t=document.getElementById("hud"),e=t.querySelector(".dots.port"),n=t.querySelector(".dots.starboard");e.innerHTML="",n.innerHTML="";const s=r.cannons.filter(o=>o.side==="port").length,i=r.cannons.filter(o=>o.side==="starboard").length;C=[],X=[];for(let o=0;o<s;o++){const a=document.createElement("span");a.className="dot",e.appendChild(a),C.push(a)}for(let o=0;o<i;o++){const a=document.createElement("span");a.className="dot",n.appendChild(a),X.push(a)}}function st(r){if(!C.length||!X.length)return;const t=r.cannons.filter(n=>n.side==="port"),e=r.cannons.filter(n=>n.side==="starboard");for(let n=0;n<C.length;n++){const s=t[n],i=C[n],o=s&&s.cooldown<=0;if(i.classList.toggle("ready",!!o),!o&&s){const a=1-s.cooldown/s.reloadTime;i.style.background=`conic-gradient(#f59e0b ${Math.max(0,Math.min(1,a))*360}deg, rgba(255,255,255,0.08) 0)`}else i.style.background=""}for(let n=0;n<X.length;n++){const s=e[n],i=X[n],o=s&&s.cooldown<=0;if(i.classList.toggle("ready",!!o),!o&&s){const a=1-s.cooldown/s.reloadTime;i.style.background=`conic-gradient(#f59e0b ${Math.max(0,Math.min(1,a))*360}deg, rgba(255,255,255,0.08) 0)`}else i.style.background=""}}function nt(r,t){if(!g)return;const e=180,n=12,s=10,i=r-e-n,o=t-e-n,a=e-s*2,l=m.maxX-m.minX,h=m.maxY-m.minY,f=Math.min(a/l,a/h),u=(a-l*f)/2,y=(a-h*f)/2;c.save(),c.fillStyle="rgba(0,0,0,0.35)",c.fillRect(i,o,e,e),c.strokeStyle="rgba(255,255,255,0.25)",c.lineWidth=2,c.strokeRect(i+.5,o+.5,e-1,e-1),c.strokeStyle="rgba(255,255,255,0.25)",c.strokeRect(i+s+u,o+s+y,l*f,h*f);for(const w of M){const x=i+s+u+(w.pos.x-m.minX)*f,v=o+s+y+(w.pos.y-m.minY)*f;c.beginPath(),c.arc(x,v,w.isPlayer?4:3,0,Math.PI*2),w.isPlayer?(c.fillStyle="#f59e0b",c.strokeStyle="#1f2937",c.lineWidth=1,c.fill(),c.stroke()):(c.fillStyle="#ef4444",c.strokeStyle="rgba(0,0,0,0.6)",c.lineWidth=1,c.fill(),c.stroke())}c.restore()}function it(r,t){const e=m.minX-S.x+r/2,n=m.minY-S.y+t/2,s=m.maxX-S.x+r/2,i=m.maxY-S.y+t/2;c.save(),c.strokeStyle="rgba(255,255,255,0.25)",c.lineWidth=2,c.strokeRect(e,n,s-e,i-n),c.restore()}function B(r){const t=r.length*.5,e=r.width*.5,n=m.minX+t,s=m.maxX-t,i=m.minY+e,o=m.maxY-e;r.pos.x<n&&(r.pos.x=n,r.vel.x<0&&(r.vel.x*=-.4)),r.pos.x>s&&(r.pos.x=s,r.vel.x>0&&(r.vel.x*=-.4)),r.pos.y<i&&(r.pos.y=i,r.vel.y<0&&(r.vel.y*=-.4)),r.pos.y>o&&(r.pos.y=o,r.vel.y>0&&(r.vel.y*=-.4))}function ot(r){for(let t=0;t<r.length;t++)for(let e=t+1;e<r.length;e++){const n=r[t],s=r[e];if(n.isSinking||s.isSinking)continue;const i=Math.max(n.length,n.width)*.4,o=Math.max(s.length,s.width)*.4,a=i+o,l=p.sub(n.pos,s.pos).len();if(l<a&&l>.1){const h=p.sub(s.pos,n.pos).normalize(),u=p.sub(n.vel,s.vel).dot(h);if(u>0)continue;const y=-1.3*u,w=p.scale(h,y),x=n.length*n.width,v=s.length*s.width,P=x+v,Y=p.scale(w,v/P),z=p.scale(w,-x/P);n.vel.add(Y),s.vel.add(z);const V=(a-l)*.5,D=p.scale(h,V);n.pos.sub(p.scale(D,v/P)),s.pos.add(p.scale(D,x/P))}}}function rt(){if(!g)return;const r=q(S,b.width,b.height),t=2,e=16;let n=0;for(const i of T)!i.isSinking&&i.pos.x>=r.left&&i.pos.x<=r.right&&i.pos.y>=r.top&&i.pos.y<=r.bottom&&n++;let s=0;for(const i of T)i.isSinking&&!i.isFullySunk()&&s++;for(;n<t&&T.length-s<e;){const i=_(g);M.push(i),T.push(i),n++}}
